# qiankun 集成 Vue2 微应用遇到的问题整理

写了一些自己在集成 微应用过程中遇到的问题，这里整理一下。这篇文章会持续跟新，可以先收藏一手哈。

## 依赖过低启动不起来

因为集成的是一个，相对比较老的系统，大概有两年代码没有改动过了。。。

vue 的版本只锁了主版本，有一些依赖版本过低，经过网络查阅是 因为vue-template-compiler 这个包的 CSS 的样式 在一些比较高的版本里 loader 改过了，用不了，所以就报错了。

我是直接锁了 vue-template-compiler 的版本到 2.6.10，相应地把 vue 的版本也给锁了2.6.10。然后重新 npm install 就可以了。

## hash 路由改为 history 路由

把路由的 mode 改成 history，因为 qiankun 官方是推荐使用 history 路由模式的

一些相对路径要改成绝对路径，比如说，在 index.html 中直接导入的文件，还有webpack 的 publicPath 也要改成绝对路径。

## 全局命名找不到

我们项目中是在 index.html 里面导入了一个config.js，然后配置了全局变量，直接在 head 中导入的，但是在主应用中加载子应用的时候，这个子应用里面的config.js能加载出来，但是全局却控制台却报警高找不到里面定义的变量。

后面改出来的方式是，去掉变量声明：

```patch
-- var baseUrl = '/app/'
++ baseUrl = '/app/'
```

## 开发环境配置 主应用中的子应用的网络请求不对

就是在开发环境中，子应用可以在主应用中正常访问，但是网络请求不对，用浏览器看了一下是没有走子应用的代理。

但是我们明明是在子应用本地服务，配了devServer的代理，为什么主应用访问不到子应用的代理呢？

原因的话其实是，子应用现在其实是跑在主应用里面，所以访问的时候会直接走主应用的代理，子应用是截取不到代理的。

解决方法的话就是在主应用里面加上子应用的代理。

需要注意的是，不能和主应用其他的代理相冲突，就算是有一部分开头一样也不行，因为代理配置一般是正则匹配，匹配以 xx 开头的，只要匹配到就直接结束了。

## 开发中 浏览器里面app.js Response选项卡显示加载失败

有人会问，我的项目里面根本就没有这个app.js，怎么会加载这个？先说一下这个app.js 是从哪里来的，细心的小伙伴如果日常开发中有留意的话，就会指导这个是 Vue 项目在开发环境下自动注入到 index.html 的，而主应用通过 import-html-entry 这个包加载子应用的静态资源的时候就会加载这个app.js文件

这个好像是正常的，开发中，其实文件是加载了的，可以从网络请求的文件大小看出来。

至于为什么浏览器显示加载失败，应该是因为跨域，因为开发中我们微应用是单独起的服务，而主应用也是单独起的服务，这两者必然是跨域的，所以浏览器会报这个错误。最直接地，可以在浏览器中看一下这个 app.js 的请求地址，可以看到端口号是和主应用是不一样的。

但是在生产中就不会有这个问题，因为生产中我们会把所有应用打包之后会到一起，不会跨域。

这个我当初在集老项目的时候，琢磨了好一会儿才反应过来。基础还是要扎实。

## 路由的访问是为空，但是也没有报错

基本上就是因为注册的 activeRule 配置和子应用的 history 的 base 路径不一致导致的。

如果说子应用需要独立配置的话，可以通过乾坤的 mounted 子应用生命周期钩子把 base 路径传给子应用，然后在子应用中更改router的base路径，不用重新new一个router实例。可以直接改，例如：

```javascript
// src/main.js
// router 是history模式的路由实例，state 是主应用传递过来的数据对象，baseUrl 是其中的属性
router.history.base = state.baseUrl;
router.options.base = state.baseUrl;
```

## 总结

本文总结自己在使用 qiankun 集成微应用中遇到的问题，以及解决方法。这篇文档应该会持续更新，大家可以点赞收藏一波，更多优质文章，请持续关注哦。
