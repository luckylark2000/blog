<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <button id="retry-btn"
          data-retry="3">发起请求</button>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>

    const btn = document.getElementById('retry-btn')
    const service = axios.create()

    function createRetryInterceptor(maxRetries = 3, retryDelay = 100) {
      return service.interceptors.response.use(
        response => response,
        async error => {
          const config = error.config;

          if (!config || !config.retry) {
            return Promise.reject(error);
          }

          config.__retryCount = config.__retryCount || 0;

          if (config.__retryCount >= maxRetries) {
            return Promise.reject(error);
          }

          config.__retryCount += 1;

          // Exponential backoff
          const delay = retryDelay * Math.pow(2, config.__retryCount - 1);
          await new Promise(resolve => setTimeout(resolve, delay));

          return service(config);
        }
      );
    }
    createRetryInterceptor(3, 100)

    function interceptor1() {
      service.interceptors.request.use(function (config) {
        console.log('请求拦截器1...')
        return config
      })
      service.interceptors.response.use(
        response => {
          console.log("响应拦截器1...")
          return response;
        },
        error => {
          console.log("错误处理：响应拦截器1...")
          return Promise.reject(error);
        }
      );
    }
    function interceptor2() {
      service.interceptors.request.use(function (config) {
        console.log('请求拦截器2...')
        return config
      })

      service.interceptors.response.use(
        response => {
          console.log("响应拦截器2...")
          return response;
        },
        error => {
          console.log("错误处理：响应拦截器2...")
          return Promise.reject(error);
        }
      );
    }

    interceptor1()
    interceptor2()

    btn.addEventListener('click', () => {
      console.log(btn.dataset)
      console.log(service)
      service.get('https://httpbin.org/status/500', { retry: true })
        .then(res => {
          console.log(res)
        })
        .catch(err => {
          console.log(err)
        })
    })
  </script>
</body>

</html>